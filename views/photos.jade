extends layout

block content
	script.
		$(function() {
			$('.gallery_selector').on('change', function(){
				var photo_id = $(this).attr('photo_id');
				var gallery_id = $(this).find(":selected").val();//('gallery_id');
				console.log(photo_id, gallery_id);
				$.ajax({
					url: '/photos/'+photo_id,
					type: 'PUT',
					data: {
						gallery_id: gallery_id
					},
					success: function(data){
						//location.reload();
					}
				});
			});
			$('#photo_upload_input').on('change', function(){
				var files = $(this).get(0).files;

				if (files.length > 0){
					// One or more files selected, process the file upload

					// create a FormData object which will be sent as the data payload in the
					// AJAX request
					var formData = new FormData();

					// loop through all the selected files
					for (var i = 0; i < files.length; i++) {
						var file = files[i];

						// add the files to formData object for the data payload
						formData.append('uploads[]', file, file.name);
					}

					console.log(formData);

					$.ajax({
						url: '/photos',
						type: 'POST',
						data: formData,
						processData: false,
						contentType: false,
						success: function(data){
							console.log('upload successful!');
						},
						xhr: function() {
							// create an XMLHttpRequest
							var xhr = new XMLHttpRequest();

							// listen to the 'progress' event
							xhr.upload.addEventListener('progress', function(evt) {

								if (evt.lengthComputable) {
									// calculate the percentage of upload completed
									var percentComplete = evt.loaded / evt.total;
									percentComplete = parseInt(percentComplete * 100);

									// update the Bootstrap progress bar with the new percentage
									$('.progress-bar').text(percentComplete + '%');
									$('.progress-bar').width(percentComplete + '%');

									// once the upload reaches 100%, set the progress bar text to done
									if (percentComplete === 100) {
										$('.progress-bar').html('Done');
									}

								}

							}, false);

							return xhr;
						}
					});
				}
			});
		});

	.container
		.row
			.col-xs-12
				.panel.panel-default
					.panel-body
						span.glyphicon.glyphicon-cloud-upload
						h2 File Uploader
						.progress
							.progress-bar(role="progressbar")
						button.btn.btn-lg.upload-btn(type="button") Upload File

	input#photo_upload_input(type="file", name="uploads[]" multiple="multiple")		


	div
		h4 Unassigned photos
		each photo in unassigned_photos
			div
				img(src="https://res.cloudinary.com/hf7ourhvw/image/upload/#{photo.cloudinary_public_id}", height="200")
				br
				select.gallery_selector(photo_id="#{photo._id}")
					option(value="", disabled=true, selected=true) Select gallery
					each gallery in galleries
						option(value="#{gallery._id}") #{gallery.title}

	each gallery in galleries
		div
			h4 #{gallery.title}
			each gallery_photo in gallery.photos
				div
					img(src="https://res.cloudinary.com/hf7ourhvw/image/upload/#{gallery_photo.cloudinary_public_id}", height="200")
					br
					select.gallery_selector(photo_id="#{gallery_photo._id}")
						each gallery in galleries
							if (gallery_photo.gallery_id.toString() === gallery._id.toString())
								option(value="#{gallery._id}", selected=true) #{gallery.title}
							else
								option(value="#{gallery._id}") #{gallery.title}


		